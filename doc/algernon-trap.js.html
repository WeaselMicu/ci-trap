<!DOCTYPE html>

<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Documentation Source: /home/oliver/Work/algernon-trap/algernon-trap.js</title>

	<!--[if lt IE 9]>
	<script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
	<![endif]-->
	<link type="text/css" rel="stylesheet" href="styles/sunlight.default.css">

	
	<link type="text/css" rel="stylesheet" href="styles/site.amelia.css">
	
</head>

<body>
<div class="container-fluid">
	<div class="navbar navbar-fixed-top ">
		<div class="navbar-inner">
			<a class="brand" href="index.html">Documentation</a>
			<ul class="nav">
				
				<li class="dropdown">
					<a href="classes.list.html" class="dropdown-toggle" data-toggle="dropdown">Classes<b
						class="caret"></b></a>

					<ul class="dropdown-menu ">
						
						<li>
							<a href="algernonTrap.html">algernonTrap</a>
						</li>
						
						<li>
							<a href="algernonTrapInstance.html">algernonTrapInstance</a>
						</li>
						

					</ul>
				</li>
				
			</ul>
		</div>
	</div>

	<div class="row-fluid">

		
			<div class="span12">
				
				<div id="main">
					


		<h1 class="page-title">Source: /home/oliver/Work/algernon-trap/algernon-trap.js</h1>
    
    <section>
        <article>
            <pre class="sunlight-highlight-javascript ">/*! algernon-trap v0.1.0 - MIT license */

/*
 * Motion event (mouse movement) catcher for browsers emitting data compatible
 * with Algernon's motion analyzer engine. (touch, gyro, etc. is WIP)
 *
 * Copyright (c) 2012--2014, GOLDA Bence &lt;gbence@algernon.hu>
 *
 * ----------------------------------------------
 *
 * Data format:
 * - head + (short-motion | long-motion | button)
 * - head:
 *   . constant: 'B' (1 byte)
 *   . version number: 1 -> 'A', 2 -> 'B', ... (1 byte)
 * - short-motion: (mousemove) &amp;&amp; |dt| &lt; 1024 &amp;&amp; |dx| &lt; 32 &amp;&amp; |dy| &lt; 32
 *   . event-type, constant: 0 (2 bits)
 *   . time-difference, integer in milliseconds: 0..1023 (10 bits)
 *   . sign of X-difference: 1->negative, 0->positive (1 bit)
 *   . absolute of X-difference: 0..31 (5 bits)
 *   . sign of Y-difference: 1->negative, 0->positive (1 bit)
 *   . absolute of Y-difference: 0..31 (5 bits)
 * - long-motion: (mousemove) &amp;&amp; (otherwise)
 *   . event-type, constant: 1 (2 bits)
 *   . time-difference, integer in milliseconds: 0..65535 (16 bits)
 *   . sign of X-difference: 1->negative, 0->positive (1 bit)
 *   . absolute of X-difference: 0..2047 (11 bits)
 *   . sign of Y-difference: 1->negative, 0->positive (1 bit)
 *   . absolute of Y-difference: 0..2047 (11 bits)
 * - button: (onclick)
 *   . event-type, constant: 2->mouse down, 3->mouse up (2 bits)
 * TODO:
 * - fix function and other head-comments to be compatible with a/some doc gen.
 * - autostart
 * - periodically emit a bufferChanged event
 * - add captureStart / captureEnd events -- or similar
 *
 * JsDoc keyword:
 * https://code.google.com/p/jsdoc-toolkit/wiki/TagReference
 *
 * @link ClassName#algernonTrap
 */

(function(global) {function moduleDefinition() {

// ---------------------------------------------------------------------------

"use strict";


// @constant
var map  = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",
  head = "BA"; // v1

// -- FNS / HELPERS ---------------------------------
var abs = Math.abs;

/**
 * @constructor algernonTrap
 * @param {String} element Html element which will be watched
 * @return {Function} Return algernonTrap, it will be the module
 */
function algernonTrap(element) {

  if(element === undefined) {
    element = document;
  }
/**
 * @memberOf algernonTrap
 * @constructor algernonTrapInstance
 * @return {function}
 */
  var algernonTrapInstance = function() {
    return algernonTrapInstance;
  },

    // -- DATA ------------------------------------------
    buffer  = head,
    running = false,
    state   = {t: 0, x: 0, y: 0},

    // DEBUG-ONLY
    rawBuffer = [],

    // -- FUNCTIONS -------------------------------------

    /**
     * Encodes and pushes values sampled by its given size into buffer.
     *
     * * values: 
     * * sizes: pairwise bit sizes for values.
     *
     */
    send = function(parameters, callback) {
      var req,
        dataString = "",
        parametersLength = 0,
        key;
      for (key in parameters) {
        if (parameters.hasOwnProperty(key)) {
          parametersLength++;
        }
      }
      for (key in parameters) {
        if (parameters.hasOwnProperty(key)) {
          dataString += key + "=" + encodeURIComponent(parameters[key].toString());
          parametersLength--;
          if (parametersLength > 0) {
            dataString += "&amp;";
          }
        }
      }

      if (window.XMLHttpRequest) { // code for IE7+, Firefox, Chrome, Opera, Safari
        req = new XMLHttpRequest();
      } else { // code for IE6, IE5
        req = new ActiveXObject("Microsoft.XMLHTTP");
      }
      req.onreadystatechange = function() {
        if (callback){
          if ((req.readyState === 4) &amp;&amp; (req.status === 200)) {
            callback(req);
          }
        }
      };
      req.open("POST", "/", true);
      req.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
      req.send(dataString);
    },

    push = function(values, sizes) {
      // DEBUG-ONLY
      rawBuffer.push([values]);

      var idx,
        len = values.length,
        bc = 0,
        av = 0,
        size; // bc==bit counter, av=actual value
      for (idx = 0; idx &lt; len; idx++) {
        size = sizes[idx];
        if (av > 0) {
          av = av &lt;&lt; size;
        }
        av |= values[idx] &amp; ((1 &lt;&lt; size) - 1);
        bc += size;
        while (bc > 6) {
          bc -= 6;
          buffer += map[av >>> bc];
          av &amp;= (1 &lt;&lt; bc) - 1;
        }
      }
      buffer += map[av &lt;&lt; (6 - bc)];
      return buffer;
    },

    /**
     * Pushes button down/up event to buffer.
     */
    mouseButtonHandler = function(event) {
      var result = true,
        t, dt,
        mouseEvent = event ? event : window.event;

      // We prepare this for other event types (eg. touch, swipe, ...).
      switch (mouseEvent.type) {
        case "mousedown":
          t = 2; // down
          break;

        case "mouseup":
          t = 3; // up
          break;
      }

      dt = mouseEvent.timeStamp - state.t;
      state.t = mouseEvent.timeStamp;

      push([t, dt > 0xffff ? 0xffff : dt], [2, 16]);

      return result;
    },

    /**
     * Pushes move event into buffer.
     */
    mouseMoveHandler = function(event) {
      var result = true,
        dx, absx,
        dy, absy,
        dt,
        mouseEvent = event ? event : window.event;

      dx      = mouseEvent.screenX - state.x;
      absx    = abs(dx);
      dy      = mouseEvent.screenY - state.y;
      absy    = abs(dy);
      dt      = mouseEvent.timeStamp - state.t;

      state.x = mouseEvent.screenX;
      state.y = mouseEvent.screenY;
      state.t = mouseEvent.timeStamp;

      // Small movements are stored in less space.
      if ((dt &lt; 1024) &amp;&amp; (absx &lt; 32) &amp;&amp; (absy &lt; 32)) {
        push([0, dt, (dx &lt; 0) ? 1 : 0, absx, (dy &lt; 0) ? 1 : 0, absy],
             [2, 10, 1, 5, 1, 5]);
      } else {
        push([1, (dt > 0xffff) ? 0xffff : dt, (dx &lt; 0) ? 1 : 0, (absx > 0x7ff) ? 0x7ff : absx, (dy &lt; 0) ? 1 : 0, (absy > 0x7ff) ? 0x7ff : absy],
             [2, 16, 1, 11, 1, 11]);
      }

      return result;
    },

    /**
     *  Start event processing.
     */
    start = function() {
      // Using addEventListener is the way forward.  For backward compatibility, use shims.
      if (running) {
        return;
      }
      element.addEventListener("mousemove", mouseMoveHandler);
      element.addEventListener("mousedown", mouseButtonHandler);
      element.addEventListener("mouseup", mouseButtonHandler);
      running = true;
    },

    /**
     *  Stop event processing.
     */
    stop = function() {
      if (!running) {
        return;
      }
      element.removeEventListener("mousemove", mouseMoveHandler);
      element.removeEventListener("mousedown", mouseButtonHandler);
      element.removeEventListener("mouseup", mouseButtonHandler);
      running = false;
    };

  algernonTrapInstance.start  = start;
  algernonTrapInstance.stop   = stop;
  algernonTrapInstance.buffer = function() {
    return buffer;
  };
  algernonTrapInstance.send   = send;
  algernonTrapInstance.sendAndReset = function(buf, callback) {
    algernonTrapInstance.send(buf, callback);
    buffer = head;
  };
  // DEBUG-ONLY
  algernonTrapInstance.rawBuffer = function() {
    return rawBuffer;
  };

  // TODO autostart

  return algernonTrapInstance;
}

/**
 * Expose algernonTrap
 */

return algernonTrap;

// ---------------------------------------------------------------------------

} if (typeof exports === "object") {
  // node export
  module.exports = moduleDefinition(/*require('dependency')*/);
} else if ((typeof define === "function") &amp;&amp; define.amd) {
  // amd anonymous module registration
  define([/*'dependency'*/], moduleDefinition);
} else {
  // browser global
  global.algernonTrap = moduleDefinition(/*global.dependency*/);
}}(this));
</pre>
        </article>
    </section>





				</div>

				<div class="clearfix"></div>
				<footer>
					
					
		<span class="jsdoc-message">
		Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.0-alpha5</a>
		on Mon Aug 04 2014 22:32:12 GMT+0200 (CEST) using the <a href="https://github.com/terryweiss/docstrap">DocStrap template</a>.
		</span>
				</footer>
			</div>

			
			<br clear="both">
		</div>

	</div>
	<script src="scripts/sunlight.js"></script>
	<script src="scripts/sunlight.javascript.js"></script>
	<script src="scripts/sunlight-plugin.doclinks.js"></script>
	<script src="scripts/sunlight-plugin.linenumbers.js"></script>
	<script src="scripts/sunlight-plugin.menu.js"></script>
	<script src="scripts/jquery.min.js"></script>
	<script src="scripts/jquery.scrollTo.js"></script>
	<script src="scripts/jquery.localScroll.js"></script>
	<script src="scripts/bootstrap-dropdown.js"></script>
	<script src="scripts/toc.js"></script>


	<script>  Sunlight.highlightAll({lineNumbers:,  showMenu: true, enableDoclinks :true}); </script>

	<script>
		$( function () {
			$( "#toc" ).toc( {
				selectors   : "h1,h2,h3,h4",
				showAndHide : false,
				scrollTo    : 60
			} );
			$( "#toc>ul" ).addClass( "nav nav-pills nav-stacked" );
			$( "#main span[id^='toc']" ).addClass( "toc-shim" );

		} );
	</script>

	

</body>
</html>
